<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ü§ñ Chatbot|Switch 1.0 ‚ö°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Global box-sizing for consistent layout calculations */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Ensure html and body take full height to act as proper flex containers */
        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', sans-serif; /* Matching portfolio font */
            background-color: #1a1d23; /* Primary background from portfolio */
            margin: 0;
            padding: 0;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            color: #e0e0e0; /* Default text color from portfolio */
        }

        h1 {
            color: #4CAF50; /* Highlight color from portfolio */
            text-align: center;
            font-size: 24px;
            margin-bottom: 10px;
            padding-top: 20px;
            flex-shrink: 0;
            /* Refined Neon effect for H1 */
            filter: drop-shadow(0 0 5px rgba(76, 175, 80, 0.8)) drop-shadow(0 0 15px rgba(76, 175, 80, 0.4));
            animation: pulse-h1 2s infinite alternate; /* Subtle pulse */
        }

        @keyframes pulse-h1 {
            from { filter: drop-shadow(0 0 5px rgba(76, 175, 80, 0.8)) drop-shadow(0 0 15px rgba(76, 175, 80, 0.4)); }
            to { filter: drop-shadow(0 0 8px rgba(76, 175, 80, 1)) drop-shadow(0 0 20px rgba(76, 175, 80, 0.6)); }
        }

        #chat-container {
            height: 60vh;
            width: 90%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            overflow-y: auto;
            background-color: #1a1d23; /* Matches body background */
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.1); /* Very subtle outer glow for container */
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(76, 175, 80, 0.08); /* Even subtler border */
        }

        /* Base style for all messages */
        .chat-message {
            padding: 12px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            max-width: 70%; 
            word-wrap: break-word; 
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; 
            display: flex; /* Use flex to control content and copy button */
            flex-direction: column; 
            position: relative; /* For copy feedback positioning */
        }

        /* User message styles */
        .user-message {
            background-color: #4CAF50; /* Green from portfolio */
            color: #ffffff;
            align-self: flex-end; /* Align to the right */
            border-bottom-right-radius: 2px; /* Small tail on bottom-right */
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.4); /* Subtle user message glow */
        }

        /* Bot message styles */
        .bot-message {
            background-color: #2d3138; /* Secondary background from portfolio */
            color: #e0e0e0;
            align-self: flex-start; /* Align to the left */
            border-bottom-left-radius: 2px; /* Small tail on bottom-left */
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.15); /* Subtle inner glow for bot message */
        }
        
        /* Loading message styles */
        .loading-message {
            background-color: #2d3138;
            color: #a0a0a0;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            animation: pulse-message 1.5s infinite ease-in-out alternate; /* Subtle pulse */
        }
        @keyframes pulse-message {
            from { box-shadow: 0 0 3px rgba(76, 175, 80, 0.1); }
            to { box-shadow: 0 0 8px rgba(76, 175, 80, 0.4); }
        }

        /* Error message styles */
        .error-message {
            background-color: #a02c2c; /* Slightly softer red for errors */
            color: #ffffff;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            box-shadow: 0 0 8px rgba(160, 44, 44, 0.6); /* Red glow for errors */
        }

        /* Hover effect for all message bubbles */
        .chat-message:hover {
            transform: translateY(-3px) scale(1.01); /* Lift and slight scale */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.8); /* Stronger green glow on hover */
        }
        /* Specific hover for error messages to keep red glow */
        .error-message:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(160, 44, 44, 0.8); 
        }

        /* Styling for the copy button */
        .copy-btn {
            background-color: #3e8e41; /* Darker green, subtle */
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75em; /* Smaller font */
            cursor: pointer;
            margin-top: 8px; /* Space from message text */
            align-self: flex-end; /* Align copy button to the right within the message bubble */
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3); /* Subtle glow */
        }
        .copy-btn:hover {
            background-color: #4CAF50;
            transform: translateY(-1px);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6); /* More prominent glow on hover */
        }
        .copy-btn:active {
            transform: translateY(0);
        }

        /* Styling for the copied feedback message */
        .copy-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            z-index: 1000;
            opacity: 0;
            animation: fadeOut 1.5s forwards;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
        }

        @keyframes fadeOut {
            0% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -70px); } /* Fades out and moves up */
        }

        #input-area {
            padding: 20px;
            background-color: #2d3138;
            border-top: 1px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 90%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 0 0 10px 10px;
            flex-shrink: 0;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.1); /* Subtle bottom glow */
        }

        #user-input {
            flex: 1;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 10px;
            font-size: 18px;
            background-color: #1a1d23;
            color: #e0e0e0;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); /* Initial subtle shadow */
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #user-input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 10px #4CAF50, inset 0 0 5px rgba(76, 175, 80, 0.3); /* Neon border glow on focus */
        }

        #send-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            background-color: #4CAF50;
            color: #fff;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5); /* Button glow */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            position: relative; 
            overflow: hidden;
        }

        #send-btn:hover {
            background-color: #3e8e41;
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(76, 175, 80, 0.8); /* Stronger glow on hover */
        }
        #send-btn:active {
            transform: translateY(0);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.4);
        }

        /* Scrollbar styles matching the dark theme with neon touch */
        body::-webkit-scrollbar {
            width: 10px;
            background-color: #1a1d23;
        }

        body::-webkit-scrollbar-thumb {
            background-color: #4CAF50; /* Green thumb */
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.4); /* Subtle glow for thumb */
        }
        body::-webkit-scrollbar-track {
            background: #2d3138; /* Dark track */
        }

        #chat-container::-webkit-scrollbar {
            width: 10px;
            background-color: #1a1d23;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background-color: #3e8e41; /* Slightly darker green for inner scrollbar */
            border-radius: 10px;
            box-shadow: 0 0 3px rgba(76, 175, 80, 0.2);
        }
        #chat-container::-webkit-scrollbar-track {
            background: #22252b; /* Dark track for inner scrollbar */
        }


        /* CSS for the enhanced typing animation */
        .typing-dots span {
            display: inline-block;
            opacity: 0;
            animation: bounce-dot 1.4s infinite;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce-dot {
            0%, 100% {
                opacity: 0;
                transform: translateY(0);
            }
            25% {
                opacity: 1;
                transform: translateY(-5px);
                text-shadow: 0 0 5px #4CAF50; /* Add glow to dots */
            }
            50% {
                opacity: 1;
                transform: translateY(0);
            }
            75% {
                opacity: 0;
            }
        }

        /* Responsive design */
        @media only screen and (max-width: 600px) {
            #chat-container, #input-area {
                width: 95%;
                padding: 15px;
            }
            #user-input {
                padding: 12px;
                font-size: 16px;
            }
            #send-btn {
                padding: 12px 20px;
                font-size: 16px;
            }
            #input-area {
                flex-direction: row;
                gap: 10px;
            }
            h1 {
                font-size: 20px; /* Adjust h1 size for smaller screens */
            }
            .chat-message {
                padding: 10px;
                font-size: 0.9em;
            }
        }

        @media only screen and (max-width: 400px) {
            #chat-container, #input-area {
                width: 98%;
                padding: 10px;
            }
            #user-input {
                padding: 10px;
                font-size: 14px;
            }
            #send-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            h1 {
                font-size: 18px; /* Further adjust h1 size for very small screens */
            }
        }
    </style>
</head>
<body>
    <h1>ü§ñ Chatbot|Switch 1.0 ‚ö°</h1>
    <div id="chat-container"></div>
    <div id="input-area"> <input type="text" id="user-input" placeholder="Type a command or ask me anything...">
        <button id="send-btn">Send</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // --- API Endpoints ---
        // Google Gemini API (for AI responses)
        const GEMINI_API_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"; 
        
        // Primary API set: giftedtech.web.id
        const GIFTEDTECH_JOKE_API_ENDPOINT = "https://api.giftedtech.web.id/api/fun/jokes";
        const GIFTEDTECH_QUOTES_API_ENDPOINT = "https://api.giftedtech.web.id/api/fun/quotes";
        const GIFTEDTECH_ADVICE_API_ENDPOINT = "https://api.giftedtech.web.id/api/fun/advice";
        const GIFTEDTECH_LOVE_API_ENDPOINT = "https://api.giftedtech.web.id/api/fun/love";
        const GIFTEDTECH_FRIENDSHIP_API_ENDPOINT = "https://api.giftedtech.web.id/api/fun/friendship";
        const GIFTEDTECH_GRATITUDE_API_ENDPOINT = "https://api.giftedtech.web.id/api/fun/gratitude";
        const GIFTEDTECH_FANCY_API_ENDPOINT = "https://api.giftedtech.web.id/api/tools/fancy";
        const GIFTEDTECH_FANCYV2_API_ENDPOINT = "https://api.giftedtech.web.id/api/tools/fancyv2";

        // Secondary API set: apis.davidcyriltech.my.id
        const DAVIDCYRILTECH_FACTS_API_ENDPOINT = "https://apis.davidcyriltech.my.id/fact";
        const DAVIDCYRILTECH_PICKUPLINE_API_ENDPOINT = "https://apis.davidcyriltech.my.id/pickupline";
        const DAVIDCYILTECH_ALT_QUOTES_API_ENDPOINT = "https://apis.davidcyriltech.my.id/random/quotes"; // Note: User requested as /altquotes
        const DAVIDCYRILTECH_TECHNEWS_API_ENDPOINT = "https://apis.davidcyriltech.my.id/random/technews";
        const DAVIDCYRILTECH_CURRENCY_CONVERTER_API_ENDPOINT = "https://apis.davidcyriltech.my.id/tools/convert";
        const DAVIDCYRILTECH_CURRENCIES_API_ENDPOINT = "https://apis.davidcyriltech.my.id/tools/currencies";
        const DAVIDCYRILTECH_AI_FALLBACK_ENDPOINT = "https://apis.davidcyriltech.my.id/ai/gemini"; // For /ai fallback

        // --- API Keys ---
        const GEMINI_API_KEY = ""; // Canvas will inject this for Google APIs
        const GIFTEDTECH_API_KEY = "gifted"; // Explicit key for giftedtech.web.id APIs
        const DAVIDCYRILTECH_API_KEY = ""; // NOTE: Set this key if required by davidcyriltech.my.id APIs

        /**
         * Utility function to copy text to clipboard and show feedback.
         * @param {string} text The text to copy.
         */
        function copyToClipboard(text) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                const copyFeedback = document.createElement('span');
                copyFeedback.textContent = 'Copied!';
                copyFeedback.classList.add('copy-feedback');
                document.body.appendChild(copyFeedback);
                setTimeout(() => {
                    if (document.body.contains(copyFeedback)) {
                        document.body.removeChild(copyFeedback);
                    }
                }, 1500);
                console.log('Text copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                // In a real application, you'd use a custom modal for this alert
                // alert('Failed to copy text. Please copy manually: ' + text); 
                displayMessage('bot', `Failed to copy text. Please copy manually: "${text}"`, 'error');
            } finally {
                if (document.body.contains(tempInput)) {
                    document.body.removeChild(tempInput);
                }
            }
        }

        // Function to display messages with proper styling based on type
        // This function no longer adds "You:" or "Bot:" prefixes, and assumes HTML content for 'bot' type
        function displayMessage(sender, text, type = 'bot') { 
            const messageDiv = document.createElement("div");
            messageDiv.classList.add('chat-message'); // Base class for all messages

            const innerContentDiv = document.createElement('div'); // To hold the actual message text/HTML
            innerContentDiv.classList.add('message-content'); // Optional class for styling content area

            if (sender === 'user') {
                messageDiv.classList.add('user-message');
                innerContentDiv.textContent = text; // Display user's text directly
            } else { // Bot messages (including loading and error)
                messageDiv.classList.add('bot-message'); // Default bot message style
                
                if (type === 'loading') {
                    messageDiv.classList.add('loading-message');
                    innerContentDiv.innerHTML = text; // Allows HTML for typing dots
                } else if (type === 'error') {
                    messageDiv.classList.add('error-message');
                    innerContentDiv.textContent = text; // Display error text directly (plain text)
                } else {
                    // Regular bot response: now always assume HTML. Parsers should ensure content is HTML or safe plain text.
                    innerContentDiv.innerHTML = text; 
                }

                // Add copy button for bot messages that are not loading
                if (type !== 'loading') {
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'Copy';
                    copyBtn.classList.add('copy-btn');
                    // Get the plain text content from the innerContentDiv for copying
                    const textToCopy = innerContentDiv.textContent; 
                    copyBtn.onclick = () => copyToClipboard(textToCopy);
                    messageDiv.appendChild(copyBtn); // Add button to the message div
                }
            }
            
            messageDiv.prepend(innerContentDiv); // Add content first
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }


        /**
         * Safely calculates a mathematical expression.
         * @param {string} expression The mathematical expression to calculate.
         * @returns {number} The result of the calculation.
         * @throws {Error} If the expression contains invalid characters or cannot be evaluated.
         */
        function safeCalculate(expression) {
            if (!/^[0-9+\-*/.\s()]+$/.test(expression)) {
                throw new Error('Invalid characters in calculation. Only numbers and basic operators are allowed.');
            }
            try {
                return new Function('return ' + expression)();
            } catch (e) {
                throw new Error('Could not evaluate expression. Please check syntax.');
            }
        }

        /**
         * Formats the raw AI response text into HTML with paragraphs, lists, and bolding.
         * @param {string} rawText The raw text response from the AI API.
         * @returns {string} The formatted HTML string.
         */
        function formatAiResponse(rawText) {
            let processedText = rawText.trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold text with **text**

            const lines = processedText.split('\n');
            let htmlOutput = [];
            let inList = false;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine === '') {
                    if (inList) {
                        htmlOutput.push('</ul>');
                        inList = false;
                    }
                    return;
                }

                if (trimmedLine.startsWith('- ')) {
                    if (!inList) {
                        htmlOutput.push('<ul>');
                        inList = true;
                    }
                    htmlOutput.push(`<li>${trimmedLine.substring(2).trim()}</li>`);
                } else {
                    if (inList) {
                        htmlOutput.push('</ul>');
                        inList = false;
                    }
                    htmlOutput.push(`<p>${trimmedLine}</p>`);
                }
            });

            if (inList) {
                htmlOutput.push('</ul>');
            }
            return htmlOutput.join('');
        }

        // --- API Response Parsers ---
        // Functions to extract content from different API response structures
        const parseGiftedTechJoke = (data) => {
            if (data.result && data.result.setup && data.result.punchline) {
                return `${data.result.setup} -- ${data.result.punchline}`;
            } else if (data.result && data.result.joke) {
                return data.result.joke;
            }
            return `Unexpected joke format from GiftedTech. Raw: ${JSON.stringify(data)}`;
        };
        const parseGiftedTechQuote = (data) => {
            if (data.result && data.result.quote && data.result.author) {
                return `"${data.result.quote}" - ${data.result.author}`;
            }
            return `Unexpected quote format from GiftedTech. Raw: ${JSON.stringify(data)}`;
        };
        const parseGiftedTechAdvice = (data) => data.result && data.result.advice ? data.result.advice : `Unexpected advice format from GiftedTech. Raw: ${JSON.stringify(data)}`;
        const parseGiftedTechLove = (data) => data.result && data.result.love ? data.result.love : `Unexpected love quote format from GiftedTech. Raw: ${JSON.stringify(data)}`;
        const parseGiftedTechFriendship = (data) => data.result && data.result.friendship ? data.result.friendship : `Unexpected friendship quote format from GiftedTech. Raw: ${JSON.stringify(data)}`;
        const parseGiftedTechGratitude = (data) => data.result && data.result.gratitude ? data.result.gratitude : `Unexpected gratitude quote format from GiftedTech. Raw: ${JSON.stringify(data)}`;
        const parseGiftedTechFancy = (data) => data.fancyText ? data.fancyText : `Unexpected fancy text format from GiftedTech. Raw: ${JSON.stringify(data)}`;

        const parseDavidCyrilTechFact = (data) => data.fact ? data.fact : `Unexpected fact format from DavidCyrilTech. Raw: ${JSON.stringify(data)}`;
        const parseDavidCyrilTechPickupline = (data) => data.pickupline ? data.pickupline : `Unexpected pickupline format from DavidCyrilTech. Raw: ${JSON.stringify(data)}`;
        const parseDavidCyrilTechAltQuote = (data) => data.quote ? data.quote : `Unexpected quotes format from DavidCyrilTech. Raw: ${JSON.stringify(data)}`;
        
        const parseDavidCyrilTechTechNews = (data) => {
            if (Array.isArray(data.news) && data.news.length > 0) {
                return "Latest Tech News:<br>" + data.news.slice(0, 5).map((item, index) => `<strong>${index + 1}. ${item.title || item.headline || 'No title'}</strong>: <a href="${item.url}" target="_blank">${item.url || 'No URL'}</a>`).join('<br>');
            }
            return `Could not retrieve tech news from DavidCyrilTech. Raw: ${JSON.stringify(data)}`;
        };

        const parseDavidCyrilTechCurrencies = (data) => {
            // Updated to correctly parse the currencies string and remove unwanted prefixes
            if (data.currencies && typeof data.currencies === 'string') {
                let currenciesString = data.currencies;
                // Explicitly remove unwanted "creator", "success", "currencies" if they appear in the string
                currenciesString = currenciesString.replace(/creator:[\s\w]+,?\s*|success:(true|false),?\s*|currencies:[\s\w]+,?\s*/gi, '').trim();

                const currencyCodes = currenciesString.split(',').map(code => code.trim()).filter(code => code); // Filter empty strings
                const displayLimit = 20; // Show first 20 for brevity in chat
                const currenciesHtml = currencyCodes.slice(0, displayLimit).map(code => `<strong>${code}</strong>`).join(', ');
                
                if (currenciesHtml) {
                    return `Available Currencies (partial list):<br>${currenciesHtml}<br><em>(For full list, use their API directly.)</em>`;
                }
            }
            // If data.currencies is not a string, or parsing failed, return generic error message
            return `Could not retrieve currencies or unexpected format from DavidCyrilTech. Raw: ${JSON.stringify(data)}`;
        };

        const parseDavidCyrilTechCurrencyConvert = (data, userQuery) => {
            // Attempt to extract details from user query as fallback for display if API response is minimal
            const match = userQuery.match(/(\d+(?:\.\d+)?)\s*([a-zA-Z]{3})\s+to\s+([a-Z]{3})/i); 
            let amount = data.amount || (match ? parseFloat(match[1]) : 'N/A');
            let from = data.from || (match ? match[2].toUpperCase() : 'N/A');
            let to = data.to || (match ? match[3].toUpperCase() : 'N/A');

            if (data.convertedAmount !== undefined) {
                return `${amount} ${from} is approximately <strong>${data.convertedAmount.toFixed(2)} ${to}</strong>.`;
            }
            return `Could not perform currency conversion. Response: ${JSON.stringify(data)}`;
        };

        const parseAiResponse = (data) => {
            if (data.candidates && data.candidates.length > 0 &&
                data.candidates[0].content && data.candidates[0].content.parts &&
                data.candidates[0].content.parts.length > 0) {
                return formatAiResponse(data.candidates[0].content.parts[0].text);
            } else if (data.response) { // Some AI APIs might just have a 'response' field
                return formatAiResponse(data.response);
            }
            return `I received an empty or unreadable AI response. Raw: ${JSON.stringify(data)}`;
        };


        /**
         * Generic function to fetch content from an API with fallback.
         * Attempts primary API first, then falls back to secondary if primary fails.
         * @param {Object} primaryConfig Configuration for the primary API: { endpoint, apiKey, queryParam, parser }
         * @param {Object} [secondaryConfig] Configuration for the secondary API: { endpoint, apiKey, queryParam, parser }
         * @param {string} loadingText Text to display while fetching.
         * @param {string} [userQuery=''] The actual query text from the user (for parsers that need it).
         */
        async function fetchAPIContentWithFallback(primaryConfig, secondaryConfig, loadingText, userQuery = '') {
            displayMessage('bot', `${loadingText}<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>`, 'loading');
            let finalContentText = "Sorry, I couldn't fetch content right now. Please try again later. üòî";
            let fetchedSuccessfully = false;

            const fetchAndParse = async (config, isPrimary) => {
                let url = config.endpoint;
                let apiKey = config.apiKey;
                let queryParams = new URLSearchParams();
                
                // Add API key if provided and not for Gemini (Canvas handles Gemini key)
                if (apiKey && config.endpoint !== GEMINI_API_ENDPOINT) { 
                    queryParams.append('apikey', apiKey);
                } else if (config.endpoint === GEMINI_API_ENDPOINT && GEMINI_API_KEY) {
                    // For Gemini, key is typically appended differently or handled by environment
                    queryParams.append('key', GEMINI_API_KEY);
                }

                // Add query parameter if defined
                if (config.queryParam && userQuery) {
                    // For currency converter, userQuery is already the formatted part like "amount=100&from=USD&to=EUR"
                    if (config.endpoint === DAVIDCYRILTECH_CURRENCY_CONVERTER_API_ENDPOINT) {
                         url += `?${userQuery}`; // Append directly as it's already formatted
                         if (apiKey) url += `&apikey=${apiKey}`; // Add API key after if present
                    } else {
                        queryParams.append(config.queryParam, encodeURIComponent(userQuery));
                    }
                } else if (config.endpoint === DAVIDCYRILTECH_CURRENCY_CONVERTER_API_ENDPOINT && apiKey) {
                     url += `?apikey=${apiKey}`; // If no query, but there is API key
                }
                
                // Construct full URL if queryParams were used
                if (queryParams.toString() && config.endpoint !== DAVIDCYRILTECH_CURRENCY_CONVERTER_API_ENDPOINT) {
                    url += `?${queryParams.toString()}`;
                }


                // Decide between POST (for Gemini) and GET
                let fetchOptions = {};
                if (config.endpoint === GEMINI_API_ENDPOINT || config.endpoint === DAVIDCYRILTECH_AI_FALLBACK_ENDPOINT) {
                    fetchOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: userQuery }] }] })
                    };
                } else {
                    fetchOptions = { method: 'GET' };
                }

                const response = await fetch(url, fetchOptions);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({})); 
                    const errorMsg = errorData.message || `${response.status} ${response.statusText}`;
                    throw new Error(`${isPrimary ? 'Primary' : 'Secondary'} API failed: ${errorMsg}`);
                }
                const data = await response.json();
                console.log(`${isPrimary ? 'Primary' : 'Secondary'} API response from ${config.endpoint}:`, data);
                return config.parser(data, userQuery); // Pass userQuery to parser
            };

            try {
                finalContentText = await fetchAndParse(primaryConfig, true);
                fetchedSuccessfully = true;
            } catch (primaryError) {
                console.warn(primaryError.message);
                if (secondaryConfig) {
                    displayMessage('bot', `Primary source failed. Attempting fallback...<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>`, 'loading');
                    try {
                        finalContentText = await fetchAndParse(secondaryConfig, false);
                        fetchedSuccessfully = true;
                    } catch (secondaryError) {
                        console.error(secondaryError.message);
                        finalContentText = `Both primary and fallback APIs failed. Error: ${secondaryError.message} üòî`;
                    }
                } else {
                    finalContentText = `Failed to fetch content. Error: ${primaryError.message} üòî`;
                }

            } finally {
                const messages = chatContainer.querySelectorAll('.loading-message');
                if (messages.length > 0) {
                    chatContainer.removeChild(messages[messages.length - 1]);
                }
                displayMessage('bot', finalContentText, fetchedSuccessfully ? 'bot' : 'error');
            }
        }

        const commands = [
            { command: "help", response: `
                <p>‚ö° Commands Protocol Activated ‚ö°</p>
                <p>Dive into the future with these functionalities:</p>
                <ul>
                    <li><strong>/help</strong>: Access this data stream. üìö</li>
                    <li><strong>/about</strong>: Unveil bot specifications. ü§ñ</li>
                    <li><strong>/dev</strong>: Developer credits log. üíª</li>
                    <li><strong>/info</strong>: General system intelligence.üí°</li>
                    <li><strong>/socials</strong>: Connect on our networks. üîó</li>
                    <li><strong>/joke</strong>: Retrieve a random humor byte. üòÇ</li>
                    <li><strong>/facts</strong>: Discover an interesting data point. ü§Ø</li>
                    <li><strong>/pickuplines</strong>: Access a charm algorithm. üòâ</li>
                    <li><strong>/quotes</strong>: Download an inspirational data packet. üí°</li>
                    <li><strong>/altquotes</strong>: Retrieve an alternative inspirational data packet. üåü</li>
                    <li><strong>/technews</strong>: Get the latest tech headlines. üì∞</li>
                    <li><strong>/advice</strong>: Access a wisdom algorithm. üß†</li>
                    <li><strong>/love</strong>: Generate a sentiment burst. ‚ù§Ô∏è</li>
                    <li><strong>/friend</strong>: Process a camaraderie encryption. ü§ù</li>
                    <li><strong>/gratitude</strong>: Synthesize an appreciation sequence. üôè</li>
                    <li><strong>/fancy [text]</strong>: Encode text with stylistic algorithms (v1). ‚ú® <em>(In Development)</em></li>
                    <li><strong>/fancy2 [text]</strong>: Encode text with stylistic algorithms (v2). üåü <em>(In Development)</em></li>
                    <li><strong>/currencies</strong>: List supported currency codes. üí≤</li>
                    <li><strong>/convert [amount] [from] [to]</strong>: Convert currency values (e.g., /convert 10 USD to EUR). üí±</li>
                    <li><strong>/quest1</strong>: Engage in coding exploration. üåê</li>
                    <li><strong>/quest2</strong>: Initiate advanced programming protocols. üöÄ</li>
                    <li><strong>/update</strong>: Check for system upgrades. ‚¨ÜÔ∏è</li>
                    <li><strong>/theme</strong>: Adjust interface schematics. üåà</li>
                    <li><strong>/reset</strong>: Reinitialize core processes. üîÑ</li>
                    <li><strong>/no.game</strong>: Current recreational modules inactive. üö´</li>
                    <li><strong>/ping</strong>: Network latency test. üì°</li>
                    <li><strong>/uptime</strong>: Display operational metrics. ‚è∞</li>
                    <li><strong>/api</strong>: Access API interface documentation. üìà</li>
                    <li><strong>/calculate [expression]</strong>: Compute complex algorithms. üßÆ</li>
                    <li><strong>/clear</strong>: Purge chat log. üóëÔ∏è</li>
                </ul>
                <p><em>Syntax: Input commands with a preceding slash '/'.</em></p>
            ` },
            { command: "about", response: "Switch 1.0 is a multipurpose online bot still in development with few inbuilt commands and integrated APIs. ü§ñ" },
            { command: "hi", response: "How are you doing today üòä" },
            { command: "what's up", response: "I'm good üëå" },
            { 
                command: "dev", 
                response: "Created By Musa Abiodun ü§ù Switch ‚Ñ¢ and other members of the class of H.A.P.E üéìüíª. We're passionate about innovation and building cool stuff! üöÄ" 
            },
            { command: "info", response: "Provides information and entertainment through various commands.üì∫" },
            { 
                command: "socials", 
                response: `
                    <p>‚ú® **Let's Connect!** üì≤</p>
                    <ul>
                        <li><strong>WhatsApp</strong>: <a href="https://wa.me/2349068649046" target="_blank">+2349068649046</a> üìû</li>
                        <li><strong>Telegram</strong>: <a href="https://t.me/lost_and_off" target="_blank">@lost_and_off</a> ‚úâÔ∏è</li>
                        <li><strong>Gmail</strong>: <a href="mailto:techxunlimited@gmail.com">techxunlimited@gmail.com</a> üìß</li>
                    </ul>
                    <p>_Feel free to reach out to our network coordinates!_ üåê</p>
                ` 
            },
            { command: "quest1", response: "Explore the world of coding and discover new things. üåê" },
            { command: "quest2", response: "Learn a new programming language and build something amazing. üíª" },
            { command: "update", response: "We're constantly updating and improving our chatbot. üöÄ" },
            { command: "theme", response: "Our theme is to provide a user-friendly and interactive experience. üåà" },
            { command: "reset", response: "Chatbot has been reset. üîÑ" },
            { command: "no.game", response: "No game available at the moment. üòî" },
            { command: "ping", response: "Pong! üèì" },
            { command: "uptime", response: "Uptime: 24/7 ‚è∞" },
            { command: "api", response: "Our API is used to provide various services and functionalities. üìà" },
            {
                command: "evaluate",
                response: () => {
                    const score = Math.floor(Math.random() * 100) + 1;
                    const encouragingWords = [
                        "Keep going!",
                        "You're on the right track!",
                        "Excellent work!",
                        "Don't give up!",
                        "You're making progress!",
                        "Great effort!",
                        "Good job!",
                        "Stay motivated!",
                        "You're doing well!",
                        "Keep pushing forward!",
                    ];
                    const encouragingWord =
                        encouragingWords[Math.floor(Math.random() * encouragingWords.length)];
                    return `<p>Evaluation Score: ${score}/100</p><p>${encouragingWord}</p>`;
                },
            },
        ];

        sendBtn.addEventListener("click", async () => {
            try { // START of added try-catch block for the entire click handler
                const userInputValue = userInput.value.trim();
                // Provide feedback if input is empty
                if (userInputValue === "") {
                    displayMessage('bot', "Please type something!", 'error');
                    return; 
                }

                displayMessage('user', userInputValue);
                userInput.value = ""; // Clear input immediately

                const lowerCaseInput = userInputValue.toLowerCase();
                let commandHandled = false;

                // --- Explicit Commands (starting with '/') ---
                if (lowerCaseInput.startsWith('/')) {
                    // Commands with GiftedTech as Primary, DavidCyrilTech as Secondary
                    if (lowerCaseInput === "/joke") {
                        await fetchAPIContentWithFallback(
                            { endpoint: GIFTEDTECH_JOKE_API_ENDPOINT, apiKey: GIFTEDTECH_API_KEY, queryParam: null, parser: parseGiftedTechJoke },
                            { endpoint: DAVIDCYRILTECH_JOKE_API_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: null, parser: parseGiftedTechJoke }, // Reusing giftedtech parser for consistency if same structure
                            "Fetching humor byte"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/quotes") {
                        await fetchAPIContentWithFallback(
                            { endpoint: GIFTEDTECH_QUOTES_API_ENDPOINT, apiKey: GIFTEDTECH_API_KEY, queryParam: null, parser: parseGiftedTechQuote },
                            { endpoint: DAVIDCYILTECH_ALT_QUOTES_API_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: null, parser: parseDavidCyrilTechAltQuote },
                            "Downloading inspirational data"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/advice") {
                        await fetchAPIContentWithFallback(
                            { endpoint: GIFTEDTECH_ADVICE_API_ENDPOINT, apiKey: GIFTEDTECH_API_KEY, queryParam: null, parser: parseGiftedTechAdvice },
                            null, // No current fallback specified for advice
                            "Accessing wisdom algorithm"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/love") {
                        await fetchAPIContentWithFallback(
                            { endpoint: GIFTEDTECH_LOVE_API_ENDPOINT, apiKey: GIFTEDTECH_API_KEY, queryParam: null, parser: parseGiftedTechLove },
                            null, // No current fallback specified for love
                            "Generating sentiment burst"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/friend") {
                        await fetchAPIContentWithFallback(
                            { endpoint: GIFTEDTECH_FRIENDSHIP_API_ENDPOINT, apiKey: GIFTEDTECH_API_KEY, queryParam: null, parser: parseGiftedTechFriendship },
                            null, // No current fallback specified for friendship
                            "Processing camaraderie encryption"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/gratitude") {
                        await fetchAPIContentWithFallback(
                            { endpoint: GIFTEDTECH_GRATITUDE_API_ENDPOINT, apiKey: GIFTEDTECH_API_KEY, queryParam: null, parser: parseGiftedTechGratitude },
                            null, // No current fallback specified for gratitude
                            "Synthesizing appreciation sequence"
                        );
                        commandHandled = true;
                    } 
                    // New DavidCyrilTech commands (as primary, no fallback for now)
                    else if (lowerCaseInput === "/facts") {
                        await fetchAPIContentWithFallback(
                            { endpoint: DAVIDCYRILTECH_FACTS_API_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: null, parser: parseDavidCyrilTechFact },
                            null,
                            "Discovering an interesting data point"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/pickuplines") {
                        await fetchAPIContentWithFallback(
                            { endpoint: DAVIDCYRILTECH_PICKUPLINE_API_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: null, parser: parseDavidCyrilTechPickupline },
                            null,
                            "Accessing a charm algorithm"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/altquotes") { // Explicit new command
                        await fetchAPIContentWithFallback(
                            { endpoint: DAVIDCYILTECH_ALT_QUOTES_API_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: null, parser: parseDavidCyrilTechAltQuote },
                            null,
                            "Retrieving an alternative inspirational data packet"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/technews") {
                        await fetchAPIContentWithFallback(
                            { endpoint: DAVIDCYRILTECH_TECHNEWS_API_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: null, parser: parseDavidCyrilTechTechNews },
                            null,
                            "Getting the latest tech headlines"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput === "/currencies") {
                        await fetchAPIContentWithFallback(
                            { endpoint: DAVIDCYRILTECH_CURRENCIES_API_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: null, parser: parseDavidCyrilTechCurrencies },
                            null,
                            "Listing supported currency codes"
                        );
                        commandHandled = true;
                    } else if (lowerCaseInput.startsWith("/convert")) {
                        const convertQuery = userInputValue.substring("/convert".length).trim();
                        const match = convertQuery.match(/(\d+(?:\.\d+)?)\s*([a-zA-Z]{3})\s+to\s+([a-zA-Z]{3})/i);
                        if (match) {
                            const amount = match[1];
                            const from = match[2].toUpperCase();
                            const to = match[3].toUpperCase();
                            await fetchAPIContentWithFallback(
                                { endpoint: DAVIDCYRILTECH_CURRENCY_CONVERTER_API_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: 'amount', parser: parseDavidCyrilTechCurrencyConvert },
                                null,
                                "Converting currency values",
                                `amount=${amount}&from=${from}&to=${to}` // Pass full query string part
                            );
                        } else {
                            displayMessage('bot', `Invalid /convert format. Use: /convert [amount] [from] to [to] (e.g., /convert 10 USD to EUR). üí±`, 'error');
                        }
                        commandHandled = true;
                    }
                    // Commands that display "in development" (Fancy Text)
                    else if (lowerCaseInput.startsWith("/fancy ")) {
                        displayMessage('bot', "This command is currently in development. Please check back later! ‚ú®");
                        commandHandled = true;
                    } else if (lowerCaseInput.startsWith("/fancy2 ")) {
                        displayMessage('bot', "This command is currently in development. Please check back later! üåü");
                        commandHandled = true;
                    } 
                    // Other existing static commands
                    else if (lowerCaseInput.startsWith("/calculate")) {
                        try {
                            const calculation = userInputValue.replace("/calculate ", "");
                            const result = safeCalculate(calculation);
                            displayMessage('bot', `Result: ${result} üßÆ`);
                        } catch (error) {
                            displayMessage('bot', `Error: ${error.message} ü§î`, 'error');
                        }
                        commandHandled = true;
                    } else if (lowerCaseInput === "/clear") {
                        chatContainer.innerHTML = "";
                        displayMessage('bot', `Chat log purged. Ready for new interactions! ‚ú®`);
                        commandHandled = true;
                    } else {
                        // Check other predefined commands (like help, about, dev, etc.)
                        const commandName = lowerCaseInput.substring(1); 
                        const command = commands.find((cmd) => cmd.command === commandName);
                        if (command) {
                            displayMessage(
                                'bot',
                                typeof command.response === "function" ? command.response() : command.response,
                                'bot' 
                            );
                            commandHandled = true;
                        } else {
                            displayMessage('bot', `Sorry, I don't recognize the command '${userInputValue}'. Type /help for available commands. üòï`, 'error');
                            commandHandled = true;
                        }
                    }
                }
                
                // --- Default to AI Query if no explicit command was handled and not a greeting ---
                if (!commandHandled) {
                    // Check for general greetings
                    if (lowerCaseInput.includes("hello") || lowerCaseInput.includes("hi") || lowerCaseInput.includes("hey")) {
                        displayMessage('bot', `How are you doing today üòä`);
                    } else {
                        // Send to AI by default
                        displayMessage('bot', `Thinking<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span> ü§î`, 'loading');
                        
                        try {
                            // AI APIs (Gemini Primary, DavidCyrilTech AI Fallback)
                            await fetchAPIContentWithFallback(
                                { endpoint: GEMINI_API_ENDPOINT, apiKey: GEMINI_API_KEY, queryParam: null, parser: parseAiResponse },
                                { endpoint: DAVIDCYRILTECH_AI_FALLBACK_ENDPOINT, apiKey: DAVIDCYRILTECH_API_KEY, queryParam: 'text', parser: parseAiResponse },
                                "Thinking",
                                userInputValue
                            );

                        } catch (error) {
                            console.error("Error with AI query:", error);
                            // The fetchAPIContentWithFallback already handles display of error
                            // So we don't need a displayMessage here unless it's a completely unhandled outer error
                        }
                    }
                }
            } catch (e) { // END of added try-catch block
                console.error("An unexpected error occurred in send button handler:", e);
                displayMessage('bot', `An unexpected internal error occurred: ${e.message}. Please try again later or contact support.`, 'error');
            }
        });

        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendBtn.click();
            }
        });
    </script>
</body>
</html>

